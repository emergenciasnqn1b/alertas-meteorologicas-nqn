
name: Alertas Meteorol√≥gicas Neuqu√©n

on:
  schedule:
    - cron: '0 * * * *'  # Cada hora
  workflow_dispatch:

jobs:
  verificar-alertas:
    runs-on: ubuntu-latest
    steps:
      - name: Clonar el repositorio
        uses: actions/checkout@v3

      - name: Instalar dependencias
        run: pip install feedparser

      - name: Verificar alertas y enviar mail
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USER }}
          GMAIL_PASS: ${{ secrets.GMAIL_PASS }}
          DESTINATARIOS: "destinatario1@example.com,destinatario2@example.com"
        run: |
          python <<EOF
          import feedparser
          import smtplib
          import json
          import os
          from email.message import EmailMessage

          zonas_neuquen = [
              "Alumin√©", "Andacollo", "Chapelco", "Chos Malal",
              "Las Lajas", "Loncopu√©", "Jun√≠n de los Andes", "San Mart√≠n de los Andes"
          ]

          mails_por_ciudad = json.loads(os.environ["MAILS_POR_CIUDAD"])

          feed = feedparser.parse("https://www.smn.gob.ar/alertas/rss")

          alertas_ciudades = {zona: [] for zona in zonas_neuquen}

          for entrada in feed.entries:
              for zona in zonas_neuquen:
                  if zona.lower() in entrada.title.lower():
                      alertas_ciudades[zona].append(f"- {entrada.title}\n{entrada.link}\n")

          for zona, alertas in alertas_ciudades.items():
              if alertas and zona in mails_por_ciudad:
                  destinatario = mails_por_ciudad[zona]

                  mensaje = EmailMessage()
                  mensaje["Subject"] = f"üö® Alerta Meteorol√≥gica en {zona}"
                  mensaje["From"] = os.environ["GMAIL_USER"]
                  mensaje["To"] = destinatario
                  mensaje.set_content("Se detectaron las siguientes alertas:\n\n" + "\n".join(alertas))

                  with smtplib.SMTP_SSL("smtp.gmail.com", 465) as smtp:
                      smtp.login(os.environ["GMAIL_USER"], os.environ["GMAIL_PASS"])
                      smtp.send_message(mensaje)
              else:
                  print(f"Sin alertas para {zona} o sin correo configurado.")
          EOF

          zonas_neuquen = [
              "Alumin√©", "Andacollo", "Chapelco", "Chos Malal",
              "Las Lajas", "Loncopu√©", "Jun√≠n de los Andes", "San Mart√≠n de los Andes"
          ]

          feed = feedparser.parse("https://www.smn.gob.ar/alertas/rss")

          alertas_relevantes = []
          for entrada in feed.entries:
              if any(zona.lower() in entrada.title.lower() for zona in zonas_neuquen):
                  alertas_relevantes.append(f"- {entrada.title}\n{entrada.link}\n")

          if alertas_relevantes:
              mensaje = EmailMessage()
              mensaje["Subject"] = "üö® Alertas Meteorol√≥gicas en zonas de Neuqu√©n"
              mensaje["From"] = "${{ secrets.GMAIL_USER }}"
              mensaje["To"] = "${{ env.DESTINATARIOS }}"
              mensaje.set_content("Se detectaron las siguientes alertas:\n\n" + "\n".join(alertas_relevantes))

              with smtplib.SMTP_SSL("smtp.gmail.com", 465) as smtp:
                  smtp.login("${{ secrets.GMAIL_USER }}", "${{ secrets.GMAIL_PASS }}")
                  smtp.send_message(mensaje)
          else:
              print("No se encontraron alertas relevantes.")
          EOF
